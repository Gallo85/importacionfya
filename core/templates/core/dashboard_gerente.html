{% extends 'core/base.html' %}
{% load humanize %}

{% block title %}üìä Dashboard Gerente{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4 text-primary text-center"><i class="bi bi-speedometer2"></i> Dashboard Gerente</h1>

    <!-- üîπ Resumen de Ventas y Facturaci√≥n -->
    <div class="row justify-content-center g-4">
        <div class="col-lg-4 col-md-6">
            <div class="card shadow-sm border-0 text-center bg-light">
                <div class="card-body">
                    <h5 class="card-title text-secondary"><i class="bi bi-receipt"></i> Facturas Generadas</h5>
                    <h2 class="fw-bold text-primary">{{ total_facturas|intcomma }}</h2>
                    <p class="text-muted small">Facturas creadas en el sistema</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="card shadow-sm border-0 text-center bg-light">
                <div class="card-body">
                    <h5 class="card-title text-secondary"><i class="bi bi-cash-stack"></i> Total de Ventas</h5>
                    <h2 class="fw-bold text-success">${{ total_ventas|floatformat:2|intcomma }}</h2>
                    <p class="text-muted small">Ventas totales en USD</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="card shadow-sm border-0 text-center bg-light">
                <div class="card-body">
                    <h5 class="card-title text-secondary"><i class="bi bi-file-earmark-minus"></i> Notas de Cr√©dito</h5>
                    <h2 class="fw-bold text-danger">{{ total_notas_credito|intcomma }}</h2>
                    <p class="text-muted small">Notas de cr√©dito emitidas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- üîπ Productos en Inventario por Tipo -->
    <div class="card shadow-lg mt-5">
        <div class="card-header bg-dark text-white text-center">
            <h6 class="mb-0"><i class="bi bi-boxes"></i> Inventario por Tipo de Producto</h6>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-4 col-sm-6 mb-2">
                    <div class="p-2 border rounded bg-light">
                        <h6 class="text-muted">üì± iPhones</h6>
                        <h5 class="fw-bold text-primary mb-0">{{ total_iphones|intcomma }}</h5>
                    </div>
                </div>
                <div class="col-md-4 col-sm-6 mb-2">
                    <div class="p-2 border rounded bg-light">
                        <h6 class="text-muted">üíª Macs</h6>
                        <h5 class="fw-bold text-primary mb-0">{{ total_macs|intcomma }}</h5>
                    </div>
                </div>
                <div class="col-md-4 col-sm-6 mb-2">
                    <div class="p-2 border rounded bg-light">
                        <h6 class="text-muted">üéß Accesorios (Total)</h6>
                        <h5 class="fw-bold text-primary mb-0">{{ total_accesorios|intcomma }}</h5>
                    </div>
                </div>
            </div>

            <!-- üîπ Detalle de Accesorios -->
            <div class="row text-center mt-3">
                <div class="col-md-3 col-sm-6 mb-2">
                    <div class="p-2 border rounded bg-light">
                        <h6 class="text-muted">üì± Fundas</h6>
                        <h6 class="fw-bold text-info mb-0">{{ total_fundas|intcomma }}</h6>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-2">
                    <div class="p-2 border rounded bg-light">
                        <h6 class="text-muted">üì± Protectores</h6>
                        <h6 class="fw-bold text-info mb-0">{{ total_protectores|intcomma }}</h6>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-2">
                    <div class="p-2 border rounded bg-light">
                        <h6 class="text-muted">üîå Cargadores</h6>
                        <h6 class="fw-bold text-info mb-0">{{ total_cargadores|intcomma }}</h6>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 mb-2">
                    <div class="p-2 border rounded bg-light">
                        <h6 class="text-muted">üéß Auriculares</h6>
                        <h6 class="fw-bold text-info mb-0">{{ total_auriculares|intcomma }}</h6>
                    </div>
                </div>
            </div> <!-- cierre del card-body de Productos en Inventario -->
        </div> <!-- cierre del card de Productos en Inventario -->

        <!-- üîπ Inversi√≥n en Inventario -->
        <div class="card shadow-lg mt-5">
            <div class="card-header bg-secondary text-white text-center">
                <h5 class="mb-0"><i class="bi bi-bar-chart-fill"></i> Inversi√≥n en Inventario</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="p-3 border rounded bg-light">
                            <h6 class="text-muted">üì± iPhones</h6>
                            <h4 class="fw-bold text-primary">${{ inversion_iphones|floatformat:2|intcomma }}</h4>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="p-3 border rounded bg-light">
                            <h6 class="text-muted">üíª Macs</h6>
                            <h4 class="fw-bold text-primary">${{ inversion_macs|floatformat:2|intcomma }}</h4>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="p-3 border rounded bg-light">
                            <h6 class="text-muted">üéß Accesorios</h6>
                            <h4 class="fw-bold text-primary">${{ inversion_accesorios|floatformat:2|intcomma }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- üîπ Balance Total -->
        <div class="alert alert-info text-center fw-bold fs-5 mt-5">
            üî• Balance Total:
            <span class="{% if balance_total >= 0 %}text-success{% else %}text-danger{% endif %}">
                ${{ balance_total|floatformat:2|intcomma }}
            </span> USD
        </div>

        <!-- üîπ Tabla de Balance por Factura -->
        <div id="resultados-balance" class="card shadow-lg mt-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Balance por Factura</h5>
            </div>
            <div class="card-body">

                <!-- üîç Filtro por Rango de Fechas -->
                <fieldset class="border rounded p-3 mb-4">
                    <legend class="float-none w-auto px-2 text-primary fw-bold">
                        <i class="bi bi-funnel-fill"></i> Filtrar Balance por Fecha
                    </legend>
                    <form method="get" action="#resultados-balance" class="row g-3 align-items-end">
                        <div class="col-md-5 col-sm-6">
                            <label for="fecha_inicio" class="form-label">Desde:</label>
                            <input type="date" id="fecha_inicio" name="fecha_inicio" class="form-control" value="{{ fecha_inicio }}">
                        </div>
                        <div class="col-md-5 col-sm-6">
                            <label for="fecha_fin" class="form-label">Hasta:</label>
                            <input type="date" id="fecha_fin" name="fecha_fin" class="form-control" value="{{ fecha_fin }}">
                        </div>
                        <div class="col-md-2 col-sm-12">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-search"></i> Filtrar
                            </button>
                        </div>
                    </form>
                </fieldset>

                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark text-center">
                            <tr>
                                <th>üßæ ID Factura</th>
                                <th>üë§ Cliente</th>
                                <th>üßë‚Äçüíº Vendedor</th>
                                <th>üìÖ Fecha Venta</th>
                                <th>üí∞ Balance Total (USD)</th>
                                <th>üîç Ver Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for factura in balance_facturas %}
                            <tr class="text-center">
                                <td>{{ factura.factura_id }}</td>
                                <td>{{ factura.cliente }}</td>
                                <td>{{ factura.vendedor }}</td>
                                <td>{{ factura.fecha_venta|date:"d/m/Y" }}</td>
                                <td class="fw-bold {% if factura.balance_total > 0 %}text-success{% else %}text-danger{% endif %}">
                                    ${{ factura.balance_total|floatformat:2|intcomma }}
                                </td>
                                <td>
                                    <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#detalleFactura{{ factura.factura_id }}">
                                        Ver Balance
                                    </button>
                                </td>
                            </tr>
                            <tr class="collapse" id="detalleFactura{{ factura.factura_id }}">
                                <td colspan="6">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-sm mb-0">
                                            <thead class="table-light text-center">
                                                <tr>
                                                    <th>üì± Modelo</th>
                                                    <th>üî¢ IMEI</th>
                                                    <th>üíµ Precio Unitario (USD)</th>
                                                    <th>üí≤ Costo Unitario (USD)</th>
                                                    <th>üî¢ Cantidad Vendida</th>
                                                    <th>üí∞ Balance (USD)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for detalle in factura.detalles %}
                                                <tr class="text-center">
                                                    <td>{{ detalle.modelo }}</td>
                                                    <td>{{ detalle.imei|default:"‚Äî" }}</td>
                                                    <td>${{ detalle.precio|floatformat:2|intcomma }}</td>
                                                    <td>${{ detalle.costo|floatformat:2|intcomma }}</td>
                                                    <td>{{ detalle.cantidad }}</td>
                                                    <td class="{% if detalle.balance > 0 %}text-success{% else %}text-danger{% endif %}">
                                                        ${{ detalle.balance|floatformat:2|intcomma }}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">‚ö†Ô∏è No hay facturas v√°lidas.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>




        <!-- üîπ Paginaci√≥n -->
        <div class="d-flex justify-content-center mt-3">
            <nav>
                <ul class="pagination">
                    {% if balance_facturas.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1">‚èÆ Primera</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ balance_facturas.previous_page_number }}">‚óÄ Anterior</a>
                        </li>
                    {% endif %}

                    <li class="page-item disabled">
                        <span class="page-link">P√°gina {{ balance_facturas.number }} de {{ balance_facturas.paginator.num_pages }}</span>
                    </li>

                    {% if balance_facturas.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ balance_facturas.next_page_number }}">Siguiente ‚ñ∂</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ balance_facturas.paginator.num_pages }}">√öltima ‚è≠</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
</div>
{% endblock %}

